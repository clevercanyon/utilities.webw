/**
 * `./.vscodeignore` generator.
 *
 * @note PLEASE DO NOT EDIT THIS FILE!
 * @note This entire file will be updated automatically.
 * @note Instead of editing here, please review <https://github.com/clevercanyon/skeleton>.
 */

import fs from 'node:fs';
import path from 'node:path';
import { $is, $path, $str, $time } from '../../../../node_modules/@clevercanyon/utilities/dist/index.js';
import generatedRegExp from '../updater/data/generated-regexp.mjs';

export default async ({ projDir }) => {
    /**
     * Initializes vars.
     */
    const vscodeIgnoreFile = path.resolve(projDir, './.vscodeignore');

    /**
     * Defines ignore contents.
     */
    let vscodeIgnoreFileContentsIgnores = $str.dedent(`
		# Last generated ${$time.i18n()}.
	`);
    for (const [groupName, group] of Object.entries($path.defaultNPMIgnoresByGroup)) {
        vscodeIgnoreFileContentsIgnores += '\n\n# ' + groupName;

        if (!$is.array(group)) {
            for (const [subgroupName, subgroup] of Object.entries(group)) {
                vscodeIgnoreFileContentsIgnores += '\n\n# Â» ' + subgroupName + '\n';

                for (const subgroupIgnore of subgroup) {
                    vscodeIgnoreFileContentsIgnores += '\n' + subgroupIgnore;
                }
            }
        } else {
            vscodeIgnoreFileContentsIgnores += '\n'; // Spacing.

            for (const groupIgnore of group) {
                vscodeIgnoreFileContentsIgnores += '\n' + groupIgnore;
            }
        }
    }

    /**
     * Defines `./.vscodeignore` file contents.
     */
    const oldFileContents = fs.readFileSync(vscodeIgnoreFile).toString();
    const vscodeIgnoreFileContents = oldFileContents.replace(
        generatedRegExp,
        ($_, $1, $2, $3) =>
            $1 + //
            '\n\n' +
            vscodeIgnoreFileContentsIgnores +
            '\n\n' +
            $3,
    );

    /**
     * Compiles `./.vscodeignore` file contents.
     */
    fs.writeFileSync(vscodeIgnoreFile, vscodeIgnoreFileContents);
};
