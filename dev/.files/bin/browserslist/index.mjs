/**
 * `./.browserslistrc` generator.
 *
 * @note PLEASE DO NOT EDIT THIS FILE!
 * @note This entire file will be updated automatically.
 * @note Instead of editing here, please review <https://github.com/clevercanyon/skeleton>.
 *
 * - browserslist-generator: <https://o5p.me/4DC1Vq>.
 * - Browserlist report on production config: <https://o5p.me/Fvs3WP>.
 * - Transpiler: <https://esbuild.github.io/content-types/#javascript>.
 */

import { browsersWithSupportForEcmaVersion } from 'browserslist-generator';
import fs from 'node:fs';
import path from 'node:path';
import { $str, $time } from '../../../../node_modules/@clevercanyon/utilities/dist/index.js';
import esVersion from '../includes/es-version.mjs';
import nodeVersion from '../includes/node-version.mjs';
import generatedRegExp from '../updater/data/generated-regexp.mjs';

export default async ({ projDir }) => {
    /**
     * Initializes vars.
     */
    const browserslistrcFile = path.resolve(projDir, './.browserslistrc');

    /**
     * Defines environment contents.
     */
    let browserslistrcFileContentsEnvs = $str.dedent(`
        # Last generated ${$time.i18n()}.
    `);
    for (const targetEnv of ['production', 'any', 'node', 'cfw', 'cfp', 'web', 'webw']) {
        switch (targetEnv) {
            default: {
                browserslistrcFileContentsEnvs += '\n\n[' + targetEnv + ']';
            }
        }
        switch (targetEnv) {
            case 'production':
            case 'any':
            case 'cfw':
            case 'cfp': {
                browserslistrcFileContentsEnvs += '\n' + 'last 1 chrome versions';
                break;
            }
        }
        switch (targetEnv) {
            case 'production':
            case 'any':
            case 'node': {
                browserslistrcFileContentsEnvs += '\n' + 'node >= ' + nodeVersion.current;
                break;
            }
        }
        switch (targetEnv) {
            case 'production':
            case 'any':
            case 'web':
            case 'webw': {
                browserslistrcFileContentsEnvs += '\n' + browsersWithSupportForEcmaVersion(esVersion.lcnYear).join('\n');
                break;
            }
        }
        switch (targetEnv) {
            default: {
                browserslistrcFileContentsEnvs += '\n' + 'not dead';
            }
        }
    }

    /**
     * Defines `./.browserslistrc` file contents.
     */
    const oldFileContents = fs.readFileSync(browserslistrcFile).toString();
    const browserslistrcFileContents = oldFileContents.replace(
        generatedRegExp,
        ($_, $1, $2, $3) =>
            $1 + //
            '\n\n' +
            browserslistrcFileContentsEnvs +
            '\n\n' +
            $3,
    );

    /**
     * Compiles `./.browserslistrc` file contents.
     */
    fs.writeFileSync(browserslistrcFile, browserslistrcFileContents);
};
