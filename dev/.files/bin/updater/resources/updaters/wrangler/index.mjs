/**
 * `./wrangler.toml` updater.
 *
 * @note PLEASE DO NOT EDIT THIS FILE!
 * @note This entire file will be updated automatically.
 * @note Instead of editing here, please review <https://github.com/clevercanyon/skeleton>.
 */

import toml from '@iarna/toml';
import fs from 'node:fs';
import path from 'node:path';
import { $prettier } from '../../../../../../../node_modules/@clevercanyon/utilities.node/dist/index.js';
import { $str, $time } from '../../../../../../../node_modules/@clevercanyon/utilities/dist/index.js';
import u from '../../../../../resources/utilities.mjs';

/**
 * Updates `./wrangler.toml` file.
 *
 * WARNING: In this file, don't use anything from our `u` (utilities) package that resolves relative directory paths
 * and/or derives information from relative directory paths, without first calling `u.switchProjDir()` to properly
 * prepare utilities. When this file is called upon, it is passed a `projDir` explicitly. This file should only operate
 * on that project directory. Also, don't forget to `u.restoreProjDir()`, to restore the previous project directory.
 */
export default async ({ projDir }) => {
    /**
     * Switches to `projDir`.
     */
    await u.switchProjDir(projDir);

    /**
     * Initializes vars.
     */
    const wranglerFile = path.resolve(u.projDir, './wrangler.toml');
    const prettierConfig = { ...(await $prettier.resolveConfig(u.pkgFile)), parser: 'toml' };

    /**
     * Defines `./wrangler.toml` file comments.
     */
    const wranglerFileComments = $str.dedent(`
        ##
        # Auto-generated Wrangler config file.
        #
        # Wrangler is aware of this config file's location.
        #
        # @note PLEASE DO NOT EDIT THIS FILE!
        # @note This entire file will be updated automatically.
        # @note Instead of editing here, please review \`./wrangler.mjs\`.
        #
        # Last generated using \`./wrangler.mjs\` ${$time.now().toProse()}.
        ##
    `);

    /**
     * Defines `./wrangler.toml` file contents.
     */
    const wranglerFileObj = (await import(path.resolve(u.projDir, './wrangler.mjs'))).default;
    const wranglerFileContents = await $prettier.format(toml.stringify(wranglerFileObj), prettierConfig);

    /**
     * Compiles `./wrangler.toml` file contents.
     */
    fs.writeFileSync(wranglerFile, wranglerFileComments + '\n\n' + wranglerFileContents);

    /**
     * Restores previous project directory.
     */
    await u.restoreProjDir();
};
