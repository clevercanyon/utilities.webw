/**
 * `./.prettierignore` updater.
 *
 * @note PLEASE DO NOT EDIT THIS FILE!
 * @note This entire file will be updated automatically.
 * @note Instead of editing here, please review <https://github.com/clevercanyon/skeleton>.
 */

import fs from 'node:fs';
import path from 'node:path';
import { $is, $path, $str, $time } from '../../../../../../../node_modules/@clevercanyon/utilities/dist/index.js';
import u from '../../../../../resources/utilities.mjs';
import generatedRegExp from '../../generated-regexp.mjs';

/**
 * Updates `./.prettierignore` file.
 *
 * WARNING: In this file, don't use anything from our `u` (utilities) package that resolves relative directory paths
 * and/or derives information from relative directory paths, without first calling `u.switchProjDir()` to properly
 * prepare utilities. When this file is called upon, it is passed a `projDir` explicitly. This file should only operate
 * on that project directory. Also, don't forget to `u.restoreProjDir()`, to restore the previous project directory.
 */
export default async ({ projDir }) => {
    /**
     * Switches to `projDir`.
     */
    await u.switchProjDir(projDir);

    /**
     * Initializes vars.
     */
    const prettierIgnoreFile = path.resolve(u.projDir, './.prettierignore');

    /**
     * Defines ignore contents.
     */
    let prettierIgnoreFileContentsIgnores = $str.dedent(`
        # Last generated ${$time.now().toProse()}.
    `);
    for (const [groupName, group] of Object.entries($path.defaultGitIgnoresByGroup())) {
        if (!['Dist', 'Packages', 'Version Control', 'Operating Systems'].includes(groupName)) {
            continue; // Not applicable; we only include select groups.
        }
        prettierIgnoreFileContentsIgnores += '\n\n# ' + groupName;

        if (!$is.array(group)) {
            for (const [subgroupName, subgroup] of Object.entries(group)) {
                prettierIgnoreFileContentsIgnores += '\n\n# » ' + subgroupName + '\n';

                for (const subgroupIgnore of subgroup) {
                    prettierIgnoreFileContentsIgnores += '\n' + subgroupIgnore;
                }
            }
        } else {
            prettierIgnoreFileContentsIgnores += '\n'; // Spacing.

            for (const groupIgnore of group) {
                prettierIgnoreFileContentsIgnores += '\n' + groupIgnore;
            }
        }
    }
    prettierIgnoreFileContentsIgnores +=
        '\n\n' +
        $str.dedent(`
        # \`.env.vault\` is generated by Dotenv Vault.
        # We don’t format this file for that reason.

        .env.vault

        # \`.editorconfig\` unsupported by Prettier at this time.
        # It's a properties file, but Prettier chokes on \`[*]\` section.

        *.editorconfig

        # \`.npmrc\` unsupported by Prettier at this time.
        # It's a properties file, but Prettier chokes on \`:\` in auth tokens.

        *.npmrc

        # EJS unsupported at this time.
        # @someday Build or find an EJS plugin.

        *.ejs
    `);

    /**
     * Defines `./.prettierignore` file contents.
     */
    const oldFileContents = fs.readFileSync(prettierIgnoreFile).toString();
    const prettierIgnoreFileContents = oldFileContents.replace(
        generatedRegExp,
        ($_, $1, $2, $3) =>
            $1 + //
            '\n\n' +
            prettierIgnoreFileContentsIgnores +
            '\n\n' +
            $3,
    );

    /**
     * Compiles `./.prettierignore` file contents.
     */
    fs.writeFileSync(prettierIgnoreFile, prettierIgnoreFileContents);

    /**
     * Restores previous project directory.
     */
    await u.restoreProjDir();
};
