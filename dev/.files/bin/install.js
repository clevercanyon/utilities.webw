#!/usr/bin/env node
/**
 * Prepare CLI.
 *
 * @note PLEASE DO NOT EDIT THIS FILE!
 * @note This entire file will be updated automatically.
 * @note Instead of editing here, please review <https://github.com/clevercanyon/skeleton>.
 */
/* eslint-env es2021, node */

import fs from 'node:fs';
import path from 'node:path';
import { dirname } from 'desm';

import yargs from 'yargs';
import { hideBin } from 'yargs/helpers';

import chalk from 'chalk';
import u from './includes/utilities.js';

u.propagateUserEnvVars(); // i.e., `USER_` env vars.

const __dirname = dirname(import.meta.url);
const projDir = path.resolve(__dirname, '../../..');

const { log } = console; // Shorter reference.

/**
 * NOTE: All commands in this file must support both interactive and noninteractive sessions. Installations occur across
 * a variety of platforms and environments. Therefore, it's important to exercise caution before making changes.
 */

/**
 * Project command.
 */
class Project {
	/**
	 * Constructor.
	 */
	constructor(args) {
		this.args = args;
	}

	/**
	 * Runs CMD.
	 */
	async run() {
		await this.install();

		if (this.args.dryRun) {
			log(chalk.cyanBright('Dry run. This was all a simulation.'));
		}
	}

	/**
	 * Runs install.
	 */
	async install() {
		/**
		 * Checks if git repo is dirty.
		 */

		if ((await u.isGitRepo()) && (await u.isGitRepoDirty())) {
			// We will allow a single `package-lock.json` change to exist as the only difference.
			// e.g., In case of `npm install` having been run vs. `npm ci`, which does better.
			if ('M package-lock.json' !== u.gitStatus({ short: true })) {
				throw new Error('Git repo is dirty.');
			}
		}

		/**
		 * Installs NPM packages; populating `./node_modules`.
		 */

		if (fs.existsSync(path.resolve(projDir, './package-lock.json'))) {
			log(chalk.green('Running a clean install of NPM packages.'));
			if (!this.args.dryRun) {
				await u.npmCleanInstall();
			}
		} else {
			log(chalk.green('Running an install of NPM packages.'));
			if (!this.args.dryRun) {
				await u.npmInstall();
			}
		}

		/**
		 * Installs Dotenv Vault variables.
		 */

		if (await u.isEnvsVault()) {
			log(chalk.green('Installing Dotenv Vault variables.'));
			if (!this.args.dryRun) {
				await u.envsInstallOrDecrypt({ mode: this.args.mode });
			}
		}

		/**
		 * Builds the app using Vite in given mode.
		 */

		log(chalk.green('Building with Vite; `' + this.args.mode + '` mode.'));
		if (!this.args.dryRun) {
			await u.viteBuild({ mode: this.args.mode });
		}

		/**
		 * Signals completion with success.
		 */

		log(await u.finale('Success', 'Project install complete.'));
	}
}

/**
 * Yargs CLI config. â›µðŸ´â€â˜ 
 *
 * @see http://yargs.js.org/docs/
 */
void (async () => {
	await yargs(hideBin(process.argv))
		.command({
			command: ['project'],
			describe: 'Installs NPM packages, envs, and builds distro.',
			builder: (yargs) => {
				return yargs
					.options({
						mode: {
							type: 'string',
							requiresArg: true,
							demandOption: false,
							default: 'prod',
							choices: ['dev', 'ci', 'stage', 'prod'],
							description: 'Build and env mode.',
						},
						dryRun: {
							type: 'boolean',
							requiresArg: false,
							demandOption: false,
							default: false,
							description: 'Dry run?',
						},
					})
					.check(async (/* args */) => {
						return true;
					});
			},
			handler: async (args) => {
				await new Project(args).run();
			},
		})
		.fail(async (message, error /* , yargs */) => {
			if (error?.stack && typeof error.stack === 'string') log(chalk.gray(error.stack));
			log(await u.error('Problem', error ? error.toString() : message || 'Unexpected unknown errror.'));
			process.exit(1);
		})
		.strict()
		.parse();
})();
