#!/usr/bin/env node
/**
 * TypeScript config file.
 *
 * TypeScript is not aware of this config file's location.
 *
 * The underlying `../../../../tsconfig.json` file can be recompiled using:
 *
 *     $ madrun update tsconfig
 *     or: $ madrun update dotfiles
 *
 * The underlying `../../../../tsconfig.json` file can be tested using:
 *
 *     $ npx tsc --showConfig
 *     $ npx tsc --emitDeclarationOnly --explainFiles
 *
 * @note PLEASE DO NOT EDIT THIS FILE!
 * @note This entire file will be updated automatically.
 * @note Instead of editing here, please review <https://github.com/clevercanyon/skeleton>.
 *
 * @see https://www.typescriptlang.org/tsconfig
 * @see https://www.typescriptlang.org/docs/handbook/module-resolution.html
 * @see https://vitejs.dev/guide/features.html#typescript-compiler-options
 */

import path from 'node:path';
import u from '../../resources/utilities.mjs';

/**
 * Defines TypeScript configuration.
 */
export default async () => {
    /**
     * Prepares relative aliases.
     */
    const relativeAliases = {}; // Initialize.

    for (const [aliasPath, realPath] of Object.entries(await u.aliases.asGlobs())) {
        let realRelativePath = path.relative(u.srcDir, realPath); // i.e., Relative to `compilerOptions.baseUrl`.
        relativeAliases[aliasPath] = [realRelativePath.startsWith('.') ? realRelativePath : './' + realRelativePath];
    }

    /**
     * Base config.
     */
    const baseConfig = {
        include: [
            './' + path.relative(u.projDir, u.srcDir) + '/**/*', //
            './' + path.relative(u.projDir, path.resolve(u.projDir, './dev-types.d.ts')),
        ],
        exclude: u.omit.asRelativeGlobs(u.projDir, [
            ...new Set(
                [
                    ...u.omit.localIgnores,
                    ...u.omit.logIgnores,
                    ...u.omit.backupIgnores,
                    ...u.omit.patchIgnores,
                    ...u.omit.editorIgnores,
                    ...u.omit.toolingIgnores,
                    ...u.omit.pkgIgnores,
                    ...u.omit.vcsIgnores,
                    ...u.omit.osIgnores,
                    ...u.omit.dotIgnores,
                    ...u.omit.configIgnores,
                    ...u.omit.lockIgnores,
                    ...u.omit.devIgnores,
                    ...u.omit.distIgnores,
                    ...u.omit.docIgnores,
                ].filter((excl) => '**/dev-types.d.ts/**' !== excl),
            ),
        ]),
        compilerOptions: {
            noEmit: true,
            declaration: true,
            declarationMap: false,

            baseUrl: './' + path.relative(u.projDir, u.srcDir),
            rootDir: './' + path.relative(u.projDir, u.srcDir),

            outDir: './' + path.relative(u.projDir, path.resolve(u.projDir, './dist')),
            declarationDir: './' + path.relative(u.projDir, path.resolve(u.projDir, './dist/types')),

            strict: true,
            skipLibCheck: true,

            target: u.es.version.lcnYear,
            lib: [u.es.version.lcnYear],
            types: [
                'vite/client', // Ambient modules provided by Vite build system.
                'unplugin-icons/types/preact', // Ambient modules for preact icons.
                '@types/mdx', // Ambient modules for MDX imports.

                'dayjs/plugin/advancedFormat', // DayJS types.
                'dayjs/plugin/customParseFormat',
                'dayjs/plugin/localizedFormat',
                'dayjs/plugin/relativeTime',
                'dayjs/plugin/timezone',
                'dayjs/plugin/toObject',
                'dayjs/plugin/utc',
            ],
            jsx: 'react-jsx',
            jsxImportSource: 'preact',

            module: 'node16',
            moduleResolution: 'node16',

            esModuleInterop: true,
            isolatedModules: true,
            resolveJsonModule: true,
            noErrorTruncation: true,
            verbatimModuleSyntax: true,
            allowImportingTsExtensions: true,

            paths: relativeAliases, // Relative to `baseUrl`.
        },
        // This is needed by the VSCode extension for MDX.
        mdx: (await (await import(path.resolve(u.projDir, './mdx.config.mjs'))).default()).vsCodeTSConfig,
    };

    /**
     * Composition.
     */
    return { ...baseConfig };
};
