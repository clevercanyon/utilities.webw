/**
 * Dependency optimizer configuration.
 *
 * Vite is not aware of this config file's location.
 *
 * @note PLEASE DO NOT EDIT THIS FILE!
 * @note This entire file will be updated automatically.
 * @note Instead of editing here, please review <https://github.com/clevercanyon/skeleton>.
 *
 * @see https://vite.dev/config/dep-optimization-options.html
 */

import u from '../../../../../resources/utilities.mjs';
import getWranglerSettings from '../../../../wrangler/resources/settings.mjs';
import mdxESBuildPluginConfig from '../../plugins/mdx/esbuild/config.mjs';

/**
 * Configures dependency optimizer.
 *
 * @param   props Props from vite config file driver.
 *
 * @returns       Dependency optimizer configuration.
 */
export default async ({ prefreshEnable }) => {
    const wranglerSettings = await getWranglerSettings();
    return {
        depsConfig: {
            force: true, // Force recreation; i.e., donâ€™t cache.

            include: [
                ...(prefreshEnable
                    ? [
                          'preact', //
                          'preact/hooks',
                          'preact/compat',
                          'preact/jsx-runtime',
                          '@preact/signals',
                      ]
                    : []),
            ].filter((name) => name !== u.pkgName && !name.startsWith(u.pkgName + '/')),

            exclude: [
                ...wranglerSettings.runtimeModules, //
                ...wranglerSettings.virtualModules,
            ],
            esbuildOptions: {
                plugins: [await mdxESBuildPluginConfig({})],
            },
        },
    };
};
