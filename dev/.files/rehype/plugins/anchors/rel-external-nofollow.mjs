/**
 * Rehype plugin.
 *
 * @note PLEASE DO NOT EDIT THIS FILE!
 * @note This entire file will be updated automatically.
 * @note Instead of editing here, please review <https://github.com/clevercanyon/skeleton>.
 */

import { visit as unistVisit } from 'unist-util-visit';

/**
 * Modifies external anchors, adding `rel="external nofollow"`, if applicable, for improved SEO.
 */
export default () => {
    return (tree) => {
        unistVisit(tree, 'element', (node) => {
            if ('a' === node.tagName && /^(?:https?:)?\/\//iu.test(node.properties.href || '')) {
                // Breaks any existing `rel=''` attribute apart into a set of values.
                let relSet = new Set((node.properties.rel || '').toLowerCase().split(/\s+/u));
                if (
                    !relSet.has('me') &&
                    !relSet.has('author') &&
                    !relSet.has('bookmark') &&
                    !relSet.has('alternate') &&
                    !relSet.has('search') &&
                    !relSet.has('next') &&
                    !relSet.has('prev') &&
                    !relSet.has('tag') &&
                    !relSet.has('help') &&
                    !relSet.has('license') &&
                    !relSet.has('privacy-policy') &&
                    !relSet.has('terms-of-service') &&
                    !relSet.has('internal')
                ) {
                    relSet.add('external');

                    if (!relSet.has('follow')) {
                        relSet.add('nofollow');
                    }
                }
                node.properties.rel = [...relSet].join(' ');
            }
            return node;
        });
    };
};
