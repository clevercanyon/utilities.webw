#!/usr/bin/env node
/**
 * Wrangler config file.
 *
 * Wrangler is not aware of this config file's location.
 *
 * The underlying `../../../wrangler.toml` file can be recompiled using:
 *
 *     $ madrun update wrangler
 *     or: $ madrun update dotfiles
 *
 * The underlying `../../../wrangler.toml` file can be partially tested using:
 *
 *     $ madrun wrangler types ... outputs: `./worker-configuration.d.ts`.
 *
 * @note PLEASE DO NOT EDIT THIS FILE!
 * @note This entire file will be updated automatically.
 * @note Instead of editing here, please review <https://github.com/clevercanyon/skeleton>.
 *
 * @see https://developers.cloudflare.com/workers/wrangler/configuration/
 */

import path from 'node:path';
import { $fs } from '../../../node_modules/@clevercanyon/utilities.node/dist/index.js';
import { $path, $str, $url } from '../../../node_modules/@clevercanyon/utilities/dist/index.js';
import extensions from '../bin/includes/extensions.mjs';
import u from '../bin/includes/utilities.mjs';

const __dirname = $fs.imuDirname(import.meta.url);
const projDir = path.resolve(__dirname, '../../..');

const pkg = await u.pkg(); // From utilities.

const defaultZoneName = 'hop.gdn';
const defaultZoneDomain = 'workers.hop.gdn';
const defaultAccountId = 'f1176464a976947aa5665d989814a4b1';
const defaultWorkerName = $str.kebabCase(path.basename(pkg.name || ''), { asciiOnly: true });

/**
 * Defines Wrangler configuration.
 */
export default async () => {
    /**
     * Base config.
     */
    const baseConfig = {
        // Platform settings.

        compatibility_date: '2023-08-15',
        send_metrics: false, // Don't share usage.
        usage_model: 'bundled', // 10M/mo free + $0.50/M.

        // Worker name & account ID.

        name: defaultWorkerName,
        account_id: defaultAccountId,

        // Workers.dev configuration.

        workers_dev: false,

        // App main entry configuration.

        main: './' + path.relative(projDir, './dist/index.js'),

        // Dynamic import configuration.

        rules: [
            {
                type: 'Text',
                globs: extensions.asNoBraceGlobstars([]),
                fallthrough: false,
            },
            {
                type: 'ESModule',
                globs: extensions.asNoBraceGlobstars([
                    ...extensions.sJavaScript, //
                    ...extensions.mJavaScript,
                    ...extensions.sJavaScriptReact,
                    ...extensions.mJavaScriptReact,
                ]),
                fallthrough: false,
            },
            {
                type: 'CommonJS',
                globs: extensions.asNoBraceGlobstars([
                    ...extensions.cJavaScript, //
                    ...extensions.cJavaScriptReact,
                ]),
                fallthrough: false,
            },
            { type: 'CompiledWasm', globs: extensions.asNoBraceGlobstars([...extensions.wasm]), fallthrough: false },
            { type: 'Data', globs: extensions.asNoBraceGlobstars([].filter((ext) => '.wasm' !== ext)), fallthrough: false },
        ],
        // Custom build configuration.

        build: {
            cwd: './' + path.relative(projDir, './'),
            watch_dir: './' + path.relative(projDir, './src'),
            command: 'npx @clevercanyon/madrun build --mode=prod',
        },
        // Worker sites; i.e., bucket configuration.

        site: {
            bucket: './' + path.relative(projDir, './dist/assets'),
            exclude: [
                ...$path.defaultNPMIgnores,
                '/a16s', // A16s (top-level only).
            ],
        },
        // Worker route configuration.

        route: {
            zone_name: defaultZoneName,
            pattern: defaultZoneDomain + '/' + $url.encode(defaultWorkerName) + '/*',
        },
        // Other environments used by this worker.

        env: {
            dev: {
                workers_dev: false,
                build: { command: 'npx @clevercanyon/madrun build --mode=dev' },
            },
        },
    };

    /**
     * Composition.
     */
    return {
        ...baseConfig,
    };
};
